---
- name: Prepare install-service assets
  hosts: assets_host
  become: true
  vars_files:
    - ../vars.yml
  pre_tasks:
    - name: Determine release version on assets host
      when: install_service_release_version | length == 0
      shell: |
        set -eu
        cd "{{ install_service_repo_path }}"
        describe=$(git describe --tags --long --dirty --abbrev=8 --match "v[0-9]*.[0-9]*.[0-9]*" --exclude "*-*" 2>/dev/null || true)
        if [ -n "$describe" ]; then
          tag="$describe"
        else
          short_sha=$(git rev-parse --short HEAD 2>/dev/null || true)
          commit_count=$(git rev-list --count HEAD 2>/dev/null || true)
          if [ -n "$short_sha" ] && [ -n "$commit_count" ]; then
            tag="v0.0.${commit_count}-${short_sha}"
            if ! git diff --quiet HEAD 2>/dev/null; then
              tag="${tag}-dirty"
            fi
          fi
        fi
        if [ -z "${tag:-}" ]; then
          tag="v0.0.0-unknown"
        fi
        if [ "{{ install_service_force_clean_git_describe | default(false) | bool }}" = "true" ]; then
          tag=$(printf '%s' "$tag" | sed -E 's/-dirty$//')
        fi
        printf '%s\n' "$tag"
      register: install_service_release_version_cmd
      changed_when: false

    - name: Set release version from git describe
      when: install_service_release_version | length == 0
      set_fact:
        install_service_release_version: "{{ install_service_release_version_cmd.stdout | trim }}"
  roles:
    - install_service_assets
