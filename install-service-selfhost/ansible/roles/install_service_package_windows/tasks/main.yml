---
- name: Ensure packaging variables provided
  assert:
    that:
      - install_service_release_version | length > 0
      - install_service_install_prefix | length > 0
      - install_service_asset_name | length > 0
      - install_service_archive_ext | length > 0
      - install_service_binary_basename | length > 0
    fail_msg: install_service_release_version, install_service_install_prefix, install_service_asset_name, and install_service_archive_ext are required

- name: Verify built binary version matches release version
  win_shell: |
    $ErrorActionPreference = "Stop"
    $expected = "{{ install_service_release_version }}"

    if ("{{ install_service_require_build_info | default(true) | bool }}" -eq "True") {
      $manifest = Join-Path "{{ install_service_install_prefix }}" "build-info.json"
      if (-not (Test-Path $manifest)) {
        throw "build-info.json is required but missing under install prefix: {{ install_service_install_prefix }}"
      }
      try {
        $info = Get-Content $manifest -Raw | ConvertFrom-Json
      } catch {
        throw "build-info.json exists but is not valid JSON: $manifest"
      }
      if (-not $info -or -not $info.git_describe) {
        throw "build-info.json missing git_describe field: $manifest"
      }
      $actual = $info.git_describe.Trim()
      if ($actual -ne $expected) {
        throw ("build-info.json version mismatch: expected={0} actual={1} (manifest={2})" -f $expected, $actual, $manifest)
      }
      exit 0
    }

    $manifest = Join-Path "{{ install_service_install_prefix }}" "build-info.json"
    if (Test-Path $manifest) {
      try {
        $info = Get-Content $manifest -Raw | ConvertFrom-Json
        if ($info -and $info.git_describe -and ($info.git_describe.Trim() -eq $expected)) {
          exit 0
        }
      } catch {
        # fall back to executing the binary
      }
    }

    $candidates = @(
      "{{ install_service_install_prefix }}\\bin\\{{ install_service_binary_basename }}.exe",
      "{{ install_service_install_prefix }}\\bin\\cert_ctrl.exe",
      "{{ install_service_install_prefix }}\\{{ install_service_binary_basename }}.exe",
      "{{ install_service_install_prefix }}\\cert_ctrl.exe"
    )
    $bin = $null
    foreach ($c in $candidates) {
      if (Test-Path $c) { $bin = $c; break }
    }
    if (-not $bin) {
      throw "unable to locate built binary under install prefix: {{ install_service_install_prefix }}"
    }
    $actual = & $bin --version 2>$null | Select-Object -First 1
    if (-not $actual) {
      throw "unable to execute built binary for version check: $bin"
    }
    $actual = $actual.Trim()
    if ($actual -ne $expected) {
      throw ("binary version mismatch: expected={0} actual={1} (bin={2})" -f $expected, $actual, $bin)
    }
  changed_when: false

- name: Upload packaging script
  copy:
    src: "{{ playbook_dir }}/../../scripts/package-windows-release.ps1"
    dest: C:\\temp\\install-service-package.ps1

- name: Package Windows release
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -File
    "C:\\temp\\install-service-package.ps1"
    -ReleaseVersion "{{ install_service_release_version }}"
    -InstallPrefix "{{ install_service_install_prefix }}"
    -AssetName "{{ install_service_asset_name }}"
    -ArchiveExt "{{ install_service_archive_ext }}"
    -BinaryBasename "{{ install_service_binary_basename }}"
    -StagingRoot "{{ install_service_remote_staging_root }}"
