---
- name: Ensure build commands provided
  assert:
    that:
      - (install_service_build_commands | length > 0) or (install_service_build_script_path | default('') | length > 0)
    fail_msg: install_service_build_commands or install_service_build_script_path is required for build hosts

- name: Build effective environment
  set_fact:
    install_service_proxy_env_effective: >-
      {{
        install_service_proxy_env
        | default({})
        | dict2items
        | rejectattr('value', 'equalto', '')
        | rejectattr('value', 'equalto', None)
        | items2dict
      }}
    install_service_build_env_effective: >-
      {{
        (install_service_build_env | default({}))
        | combine(
          (
            install_service_docker_buildkit is not none and
            (install_service_docker_buildkit | string | length) > 0
          )
          | ternary({'DOCKER_BUILDKIT': (install_service_docker_buildkit | string)}, {})
        )
        | combine(
          (
            (install_service_force_build | bool)
            or (
              (install_service_auto_force_build_on_release_version | default(true) | bool)
              and (install_service_release_version | default('') | trim | length > 0)
            )
          )
          | ternary({'INSTALL_SERVICE_FORCE_BUILD': '1'}, {'INSTALL_SERVICE_FORCE_BUILD': '0'})
        )
        | combine(
          (install_service_reconfig_cmake | default(false) | bool)
          | ternary({'INSTALL_SERVICE_RECONFIG_CMAKE': '1'}, {'INSTALL_SERVICE_RECONFIG_CMAKE': '0'})
        )
      }}
    install_service_env_effective: >-
      {{
        (install_service_proxy_env_effective | default({}))
        | combine(install_service_build_env_effective | default({}))
      }}
    install_service_ps_path_block: >-
      $extraPath = $env:INSTALL_SERVICE_PATH_EXTRA;
      if ($extraPath) { $env:PATH = "$env:PATH;$extraPath"; };
    install_service_ps_msvc_block: >-
      {%- if install_service_msvc_env | default(false) | bool -%}
      $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\\Installer\\vswhere.exe";
      if (Test-Path $vswhere) {
        $vsInstall = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath;
        if ($vsInstall) {
          $vcvars = Join-Path $vsInstall "VC\\Auxiliary\\Build\\vcvars64.bat";
          if (Test-Path $vcvars) {
            $envBlock = cmd /c "`"$vcvars`" >nul && set";
            foreach ($line in $envBlock) {
              if ($line -match ''^(?<name>[^=]+)=(?<val>.*)$'') {
                [Environment]::SetEnvironmentVariable($matches.name, $matches.val);
              }
            }
          }
        }
      };
      {%- endif -%}
    install_service_git_low_speed_args: >-
      {{
        (
          (install_service_git_low_speed_limit | int) > 0
          and (install_service_git_low_speed_time | int) > 0
        )
        | ternary(
          '-c http.lowSpeedLimit=' ~ (install_service_git_low_speed_limit | string)
          ~ ' -c http.lowSpeedTime=' ~ (install_service_git_low_speed_time | string),
          ''
        )
      }}

- name: Build proxy environment variants
  set_fact:
    install_service_proxy_env_keys_all: >-
      {{
        (
          (install_service_proxy_env_effective.keys() | list)
          + (install_service_proxy_env_effective.keys() | list | map('upper') | list)
          + (install_service_proxy_env_effective.keys() | list | map('lower') | list)
        ) | unique
      }}
    install_service_env_no_proxy: >-
      {{
        (install_service_env_effective | default({}))
        | dict2items
        | rejectattr('key', 'in', install_service_proxy_env_keys_all | default([]))
        | items2dict
      }}
    install_service_ps_env_block: >-
      {%- set ns = namespace(parts=[]) -%}
      {%- for item in install_service_env_effective | default({}) | dict2items -%}
      {%- set value = item.value | replace("\"", "`\"") -%}
      {%- set _ = ns.parts.append("$env:" ~ item.key ~ " = \"" ~ value ~ "\"") -%}
      {%- endfor -%}
      {{ ns.parts | join('; ') }}{% if ns.parts | length > 0 %}; {% endif %}
    install_service_ps_env_block_no_proxy: >-
      {%- set ns = namespace(parts=[]) -%}
      {%- for item in install_service_env_no_proxy | default({}) | dict2items -%}
      {%- set value = item.value | replace("\"", "`\"") -%}
      {%- set _ = ns.parts.append("$env:" ~ item.key ~ " = \"" ~ value ~ "\"") -%}
      {%- endfor -%}
      {%- for key in install_service_proxy_env_keys_all | default([]) -%}
      {%- set _ = ns.parts.append("Remove-Item Env:" ~ key ~ " -ErrorAction SilentlyContinue") -%}
      {%- endfor -%}
      {{ ns.parts | join('; ') }}{% if ns.parts | length > 0 %}; {% endif %}

- name: Build PowerShell preamble
  set_fact:
    install_service_ps_preamble: >-
      {{ install_service_ps_env_block }}{{ install_service_ps_msvc_block }}{{ install_service_ps_path_block }}
    install_service_ps_preamble_no_proxy: >-
      {{ install_service_ps_env_block_no_proxy }}{{ install_service_ps_msvc_block }}{{ install_service_ps_path_block }}

- name: Set build log path
  set_fact:
    install_service_build_log_path: >-
      {{
        install_service_is_windows
        | ternary(install_service_build_log_path_win, install_service_build_log_path_posix)
      }}

- name: Set build log directory (POSIX)
  when: not install_service_is_windows
  set_fact:
    install_service_build_log_dir: "{{ install_service_build_log_path | dirname }}"

- name: Check build log directory (POSIX)
  when: not install_service_is_windows and install_service_build_log_dir not in ['/tmp', '/private/tmp', '.']
  stat:
    path: "{{ install_service_build_log_dir }}"
  register: install_service_build_log_dir_stat

- name: Ensure build log directory exists (POSIX)
  when: not install_service_is_windows and install_service_build_log_dir not in ['/tmp', '/private/tmp', '.'] and not install_service_build_log_dir_stat.stat.exists
  file:
    path: "{{ install_service_build_log_dir }}"
    state: directory
    mode: '0755'

- name: Truncate build log (POSIX)
  when: not install_service_is_windows
  shell: ": > \"{{ install_service_build_log_path }}\""

- name: Truncate build log (Windows)
  when: install_service_is_windows
  ansible.windows.win_shell: |
    $logPath = "{{ install_service_build_log_path }}"
    $logDir = Split-Path -Parent $logPath
    if ($logDir -and -not (Test-Path $logDir)) {
      New-Item -ItemType Directory -Force -Path $logDir | Out-Null
    }
    "" | Out-File -FilePath $logPath -Encoding ascii

- name: Report build log path
  debug:
    msg: "Build log path: {{ install_service_build_log_path }}"

- name: Report proxy usage
  debug:
    msg: "Proxy configured via install_service_proxy_env: {{ install_service_proxy_env_effective.keys() | list | join(', ') }}"
  when: install_service_proxy_env_effective is defined and install_service_proxy_env_effective | length > 0

- name: Check repository exists (POSIX)
  stat:
    path: "{{ install_service_repo_path }}"
  register: install_service_repo_stat
  when: not install_service_is_windows

- name: Check repository directory exists (Windows)
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    'if (Test-Path "{{ install_service_repo_path }}") { exit 0 } else { exit 1 }'
  register: install_service_repo_stat_win
  failed_when: false
  changed_when: false
  when: install_service_is_windows

- name: Check repository is a git worktree (Windows)
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    'if (Test-Path "{{ install_service_repo_path }}\\.git") { exit 0 } else { exit 1 }'
  register: install_service_repo_git_win
  failed_when: false
  changed_when: false
  when: install_service_is_windows and install_service_repo_stat_win.rc == 0

- name: Default git repo status when path missing (Windows)
  set_fact:
    install_service_repo_git_win:
      rc: 1
  when: install_service_is_windows and install_service_repo_stat_win.rc != 0

- name: Fail when repo path exists but is not a git worktree (Windows)
  when: install_service_is_windows and install_service_repo_stat_win.rc == 0 and install_service_repo_git_win.rc != 0 and not install_service_repo_force_reclone | bool
  fail:
    msg: >-
      install_service_repo_path exists but is not a git repository.
      Set install_service_repo_force_reclone=true or pick a different install_service_repo_path.

- name: Remove non-git repo path before reclone (Windows)
  when: install_service_is_windows and install_service_repo_stat_win.rc == 0 and install_service_repo_git_win.rc != 0 and install_service_repo_force_reclone | bool
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    'Remove-Item -Recurse -Force "{{ install_service_repo_path }}"'

- name: Clone repository (POSIX)
  when: not install_service_is_windows and not install_service_repo_stat.stat.exists
  command: git clone --depth 1 "{{ install_service_repo_url }}" "{{ install_service_repo_path }}"
  environment: "{{ install_service_env_effective }}"

- name: Clone repository (Windows)
  when: install_service_is_windows and install_service_repo_git_win.rc != 0
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    '{{ install_service_ps_env_block }}git clone --depth 1 "{{ install_service_repo_url }}" "{{ install_service_repo_path }}"'

- name: Update repository (POSIX)
  when: not install_service_is_windows and not install_service_skip_git_pull | bool and install_service_repo_stat.stat.exists
  block:
    - name: Update repository (POSIX, proxy)
      shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" pull --ff-only
      register: install_service_git_pull_posix
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_pull_posix.rc == 0
      changed_when: false
      environment: "{{ install_service_env_effective }}"
  rescue:
    - name: Fail update repository without proxy disabled (POSIX)
      when: not install_service_git_try_without_proxy | bool
      fail:
        msg: "git pull failed with proxy; set install_service_git_try_without_proxy=true to retry without proxy."
    - name: Update repository (POSIX, no proxy)
      when: install_service_git_try_without_proxy | bool
      shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" pull --ff-only
      register: install_service_git_pull_posix
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_pull_posix.rc == 0
      changed_when: false
      environment: "{{ install_service_env_no_proxy }}"

- name: Update repository (Windows)
  when: install_service_is_windows and not install_service_skip_git_pull | bool and install_service_repo_git_win.rc == 0
  block:
    - name: Update repository (Windows, proxy)
      raw: >-
        & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
        '{{ install_service_ps_preamble }}git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" pull --ff-only'
      register: install_service_git_pull_win
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_pull_win.rc == 0
      changed_when: false
  rescue:
    - name: Fail update repository without proxy disabled (Windows)
      when: not install_service_git_try_without_proxy | bool
      fail:
        msg: "git pull failed with proxy; set install_service_git_try_without_proxy=true to retry without proxy."
    - name: Update repository (Windows, no proxy)
      when: install_service_git_try_without_proxy | bool
      raw: >-
        & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
        '{{ install_service_ps_preamble_no_proxy }}git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" pull --ff-only'
      register: install_service_git_pull_win
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_pull_win.rc == 0
      changed_when: false

- name: Fetch repository tags (POSIX)
  when: not install_service_is_windows and not install_service_skip_git_fetch_tags | bool
  block:
    - name: Fetch repository tags (POSIX, proxy)
      shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" fetch --tags --force
      register: install_service_git_fetch_posix
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_fetch_posix.rc == 0
      changed_when: false
      environment: "{{ install_service_env_effective }}"
  rescue:
    - name: Fail fetch tags without proxy disabled (POSIX)
      when: not install_service_git_try_without_proxy | bool
      fail:
        msg: "git fetch --tags failed with proxy; set install_service_git_try_without_proxy=true to retry without proxy."
    - name: Fetch repository tags (POSIX, no proxy)
      when: install_service_git_try_without_proxy | bool
      shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" fetch --tags --force
      register: install_service_git_fetch_posix
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_fetch_posix.rc == 0
      changed_when: false
      environment: "{{ install_service_env_no_proxy }}"

- name: Derive desired git ref from release version
  when: install_service_checkout_release_ref | default(true) | bool and install_service_release_version | default('') | trim | length > 0
  set_fact:
    install_service_release_git_sha: >-
      {{
        (install_service_release_version | trim)
        | regex_search('g([0-9a-fA-F]{7,40})$', '\\1')
        | default('')
        | lower
      }}

- name: Detect shallow git clone (POSIX)
  when: not install_service_is_windows and install_service_checkout_release_ref | default(true) | bool and install_service_release_version | default('') | trim | length > 0
  stat:
    path: "{{ install_service_repo_path }}/.git/shallow"
  register: install_service_repo_shallow
  changed_when: false

- name: Normalize shallow clone detection (POSIX)
  when: not install_service_is_windows and install_service_checkout_release_ref | default(true) | bool and install_service_release_version | default('') | trim | length > 0
  set_fact:
    install_service_repo_is_shallow: >-
      {{
        (
          install_service_repo_shallow is defined
          and install_service_repo_shallow.stat is defined
          and (install_service_repo_shallow.stat.exists | default(false))
        ) | bool
      }}

- name: Unshallow fetch before checkout (POSIX)
  when: not install_service_is_windows and (install_service_repo_is_shallow | default(false) | bool) and install_service_checkout_release_ref | default(true) | bool and install_service_release_version | default('') | trim | length > 0
  shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" fetch --unshallow --tags --force
  changed_when: false
  failed_when: false
  environment: "{{ install_service_env_effective }}"

- name: Checkout requested release commit or tag (POSIX)
  when: not install_service_is_windows and install_service_checkout_release_ref | default(true) | bool and install_service_release_version | default('') | trim | length > 0
  shell: |
    set -eu
    cd "{{ install_service_repo_path }}"
    ref="{{ (install_service_release_git_sha | default('') | trim) if ((install_service_release_git_sha | default('') | trim) | length > 0) else (install_service_release_version | trim) }}"
    # If ref looks like a commit sha, verify it exists; otherwise treat as tag/branch.
    if echo "$ref" | grep -Eq '^[0-9a-f]{7,40}$'; then
      git cat-file -e "$ref^{commit}"
    fi
    git checkout -f "$ref"
  changed_when: false
  environment: "{{ install_service_env_effective }}"

- name: Fetch repository tags (Windows)
  when: install_service_is_windows and install_service_repo_git_win.rc == 0 and not install_service_skip_git_fetch_tags | bool
  block:
    - name: Fetch repository tags (Windows, proxy)
      raw: >-
        & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
        '{{ install_service_ps_preamble }}git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" fetch --tags --force'
      register: install_service_git_fetch_win
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_fetch_win.rc == 0
      changed_when: false
  rescue:
    - name: Fail fetch tags without proxy disabled (Windows)
      when: not install_service_git_try_without_proxy | bool
      fail:
        msg: "git fetch --tags failed with proxy; set install_service_git_try_without_proxy=true to retry without proxy."
    - name: Fetch repository tags (Windows, no proxy)
      when: install_service_git_try_without_proxy | bool
      raw: >-
        & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
        '{{ install_service_ps_preamble_no_proxy }}git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" fetch --tags --force'
      register: install_service_git_fetch_win
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_fetch_win.rc == 0
      changed_when: false

- name: Check submodule status (POSIX)
  when: not install_service_is_windows and install_service_update_submodules | bool
  shell: git -C "{{ install_service_repo_path }}" submodule status
  register: install_service_submodule_status
  changed_when: false
  failed_when: false
  environment: "{{ install_service_env_effective }}"

- name: Decide whether to update submodules (POSIX)
  when: not install_service_is_windows and install_service_update_submodules | bool
  set_fact:
    install_service_submodule_needs_update: >-
      {{
        install_service_force_submodule_update | bool
        or (install_service_submodule_status.rc | default(1) != 0)
        or (install_service_submodule_status.stdout | default('') is search('(?m)^[-+U]'))
      }}

- name: Update submodules (POSIX)
  when: not install_service_is_windows and install_service_update_submodules | bool and install_service_submodule_needs_update | bool
  block:
    - name: Update submodules (POSIX, proxy)
      shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" submodule update --init --recursive
      register: install_service_git_submodule_posix
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_submodule_posix.rc == 0
      changed_when: false
      environment: "{{ install_service_env_effective }}"
  rescue:
    - name: Fail submodule update without proxy disabled (POSIX)
      when: not install_service_git_try_without_proxy | bool
      fail:
        msg: "git submodule update failed with proxy; set install_service_git_try_without_proxy=true to retry without proxy."
    - name: Update submodules (POSIX, no proxy)
      when: install_service_git_try_without_proxy | bool
      shell: git {{ install_service_git_low_speed_args }} -C "{{ install_service_repo_path }}" submodule update --init --recursive
      register: install_service_git_submodule_posix
      retries: "{{ install_service_git_retry_count }}"
      delay: "{{ install_service_git_retry_delay }}"
      until: install_service_git_submodule_posix.rc == 0
      changed_when: false
      environment: "{{ install_service_env_no_proxy }}"

- name: Determine release version (POSIX)
  when: not install_service_is_windows and install_service_release_version | length == 0
  shell: |
    set -eu
    cd "{{ install_service_repo_path }}"
    describe=$(git describe --tags --long --dirty --abbrev=8 --match "v[0-9]*.[0-9]*.[0-9]*" --exclude "*-*" 2>/dev/null || true)
    if [ -n "$describe" ]; then
      tag="$describe"
    else
      short_sha=$(git rev-parse --short HEAD 2>/dev/null || true)
      commit_count=$(git rev-list --count HEAD 2>/dev/null || true)
      if [ -n "$short_sha" ] && [ -n "$commit_count" ]; then
        tag="v0.0.${commit_count}-${short_sha}"
        if ! git diff --quiet HEAD 2>/dev/null; then
          tag="${tag}-dirty"
        fi
      fi
    fi
    if [ -z "${tag:-}" ]; then
      tag="v0.0.0-unknown"
    fi
    if [ "{{ install_service_force_clean_git_describe | bool | lower }}" = "true" ]; then
      tag=$(printf '%s' "$tag" | sed -E 's/-dirty$//')
    fi
    printf '%s\n' "$tag"
  register: install_service_release_version_cmd_posix
  changed_when: false

- name: Determine release version (Windows)
  when: install_service_is_windows and install_service_release_version | length == 0 and install_service_repo_git_win.rc == 0
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    '$ErrorActionPreference = "Stop";
    Set-Location "{{ install_service_repo_path }}";
    $describe = git describe --tags --long --dirty --abbrev=8 --match "v[0-9]*.[0-9]*.[0-9]*" --exclude "*-*" 2>$null;
    if ($LASTEXITCODE -eq 0 -and $describe) { $tag = $describe.Trim() }
    else {
      $shortSha = git rev-parse --short HEAD 2>$null;
      $commitCount = git rev-list --count HEAD 2>$null;
      if ($shortSha -and $commitCount) {
        $tag = "v0.0.$commitCount-$shortSha";
        git diff --quiet HEAD 2>$null;
        if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne 128) {
          $tag = (''{0}-dirty'' -f $tag);
        }
      }
    }
    if (-not $tag) { $tag = "v0.0.0-unknown" }
    if ({{ install_service_force_clean_git_describe | bool | lower }}) { $tag = $tag -replace ''-dirty$'', '''' }
    Write-Output $tag'
  register: install_service_release_version_cmd_win
  changed_when: false

- name: Set release version from git describe
  when: install_service_release_version | length == 0
  set_fact:
    install_service_release_version: >-
      {{
        (install_service_release_version_cmd_posix.stdout | default(''))
        or (install_service_release_version_cmd_win.stdout | default(''))
      | trim }}

- name: Refresh effective environment after release version is known
  set_fact:
    install_service_build_env_effective: >-
      {{
        (install_service_build_env | default({}))
        | combine(
          (
            install_service_docker_buildkit is not none and
            (install_service_docker_buildkit | string | length) > 0
          )
          | ternary({'DOCKER_BUILDKIT': (install_service_docker_buildkit | string)}, {})
        )
        | combine(
          (
            (install_service_force_build | bool)
            or (
              (install_service_auto_force_build_on_release_version | default(true) | bool)
              and (install_service_release_version | default('') | trim | length > 0)
            )
          )
          | ternary({'INSTALL_SERVICE_FORCE_BUILD': '1'}, {'INSTALL_SERVICE_FORCE_BUILD': '0'})
        )
        | combine(
          (install_service_reconfig_cmake | default(false) | bool)
          | ternary({'INSTALL_SERVICE_RECONFIG_CMAKE': '1'}, {'INSTALL_SERVICE_RECONFIG_CMAKE': '0'})
        )
      }}
    install_service_env_effective: >-
      {{
        (install_service_proxy_env_effective | default({}))
        | combine(install_service_build_env_effective | default({}))
      }}

- name: Refresh environment variants after release version is known
  set_fact:
    install_service_proxy_env_keys_all: >-
      {{
        (
          (install_service_proxy_env_effective.keys() | list)
          + (install_service_proxy_env_effective.keys() | list | map('upper') | list)
          + (install_service_proxy_env_effective.keys() | list | map('lower') | list)
        ) | unique
      }}
    install_service_env_no_proxy: >-
      {{
        (install_service_env_effective | default({}))
        | dict2items
        | rejectattr('key', 'in', install_service_proxy_env_keys_all | default([]))
        | items2dict
      }}
    install_service_ps_env_block: >-
      {%- set ns = namespace(parts=[]) -%}
      {%- for item in install_service_env_effective | default({}) | dict2items -%}
      {%- set value = item.value | replace("\"", "`\"") -%}
      {%- set _ = ns.parts.append("$env:" ~ item.key ~ " = \"" ~ value ~ "\"") -%}
      {%- endfor -%}
      {{ ns.parts | join('; ') }}{% if ns.parts | length > 0 %}; {% endif %}
    install_service_ps_env_block_no_proxy: >-
      {%- set ns = namespace(parts=[]) -%}
      {%- for item in install_service_env_no_proxy | default({}) | dict2items -%}
      {%- set value = item.value | replace("\"", "`\"") -%}
      {%- set _ = ns.parts.append("$env:" ~ item.key ~ " = \"" ~ value ~ "\"") -%}
      {%- endfor -%}
      {%- for key in install_service_proxy_env_keys_all | default([]) -%}
      {%- set _ = ns.parts.append("Remove-Item Env:" ~ key ~ " -ErrorAction SilentlyContinue") -%}
      {%- endfor -%}
      {{ ns.parts | join('; ') }}{% if ns.parts | length > 0 %}; {% endif %}
    install_service_ps_preamble: >-
      {{ install_service_ps_env_block }}{{ install_service_ps_msvc_block }}{{ install_service_ps_path_block }}
    install_service_ps_preamble_no_proxy: >-
      {{ install_service_ps_env_block_no_proxy }}{{ install_service_ps_msvc_block }}{{ install_service_ps_path_block }}

- name: Upload build script (POSIX)
  when: not install_service_is_windows and install_service_build_script_path | default('') | length > 0
  copy:
    src: "{{ install_service_build_script_path }}"
    dest: "{{ install_service_build_script_remote_path | default('/tmp/install-service-build.sh') }}"
    mode: "0755"

- name: Upload build script (Windows)
  when: install_service_is_windows and install_service_build_script_path | default('') | length > 0
  copy:
    src: "{{ install_service_build_script_path }}"
    dest: "{{ install_service_build_script_remote_path | default('C:\\\\temp\\\\install-service-build.ps1') }}"

- name: Run build script (POSIX)
  when: not install_service_is_windows and install_service_build_script_path | default('') | length > 0
  shell: |
    if (set -o pipefail) 2>/dev/null; then :; fi
    {{ install_service_build_script_remote_path | default('/tmp/install-service-build.sh') }} 2>&1 | tee -a "{{ install_service_build_log_path }}"
  args:
    chdir: "{{ install_service_repo_path }}"
  environment: "{{ install_service_env_effective | combine({'INSTALL_SERVICE_REPO_PATH': install_service_repo_path}) }}"

- name: Run build commands
  when: not install_service_is_windows and install_service_build_script_path | default('') | length == 0
  shell: |
    if (set -o pipefail) 2>/dev/null; then :; fi
    {{ item }} 2>&1 | tee -a "{{ install_service_build_log_path }}"
  args:
    chdir: "{{ install_service_repo_path }}"
  environment: "{{ install_service_env_effective }}"
  loop: "{{ install_service_build_commands }}"

- name: Run build commands (Windows)
  when: install_service_is_windows and install_service_build_script_path | default('') | length == 0
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    '{{ install_service_ps_preamble }}Set-Location "{{ install_service_repo_path }}";
    & { {{ item }} }'
  loop: "{{ install_service_build_commands }}"
  changed_when: false

- name: Run build script (Windows)
  when: install_service_is_windows and install_service_build_script_path | default('') | length > 0
  raw: >-
    & "{{ install_service_powershell_executable }}" -NoProfile -NonInteractive -ExecutionPolicy Bypass -Command
    '{{ install_service_ps_preamble }}& "{{ install_service_build_script_remote_path | default('C:\\\\temp\\\\install-service-build.ps1') }}" -RepoPath "{{ install_service_repo_path }}" -BuildTarget cert_ctrl'
